---
// Diary Editor component
---

<div
  class="bg-card rounded-lg border border-border flex flex-col h-[45vh] lg:h-[55vh]"
>
  <div class="p-4 border-b border-border flex items-center justify-between">
    <div class="flex items-center gap-2">
      <svg
        xmlns="http://www.w3.org/2000/svg"
        width="20"
        height="20"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        stroke-width="2"
        stroke-linecap="round"
        stroke-linejoin="round"
        class="text-primary"
        ><path d="M8 2v4"></path><path d="M16 2v4"></path><rect
          width="18"
          height="18"
          x="3"
          y="4"
          rx="2"></rect><path d="M3 10h18"></path></svg
      >
      <div>
        <h2 class="font-semibold text-foreground">Entrada de Hoy</h2>
        <input
          id="diary-date"
          type="date"
          class="bg-transparent border-none text-xs text-muted-foreground focus:outline-none focus:ring-1 focus:ring-primary rounded px-1"
        />
      </div>
    </div>
    <button
      id="save-btn"
      class="px-3 py-2 bg-primary text-primary-foreground rounded-md text-sm flex items-center gap-2 hover:bg-primary/90 transition-colors"
    >
      <svg
        xmlns="http://www.w3.org/2000/svg"
        width="16"
        height="16"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        stroke-width="2"
        stroke-linecap="round"
        stroke-linejoin="round"
        ><path
          d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"
        ></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline
          points="7 3 7 8 15 8"></polyline></svg
      >
      Guardar
    </button>
  </div>

  <div class="flex-1 p-4 overflow-y-auto">
    <textarea
      id="diary-content"
      placeholder="¿Cómo te sientes hoy? Escribe sobre tu día, emociones, pensamientos..."
      class="w-full h-full bg-transparent resize-none focus:outline-none text-foreground placeholder:text-muted-foreground text-base leading-relaxed"
    ></textarea>
  </div>

  <div
    class="p-3 border-t border-border flex items-center justify-between text-xs text-muted-foreground"
  >
    <span id="char-count">0 caracteres</span>
    <span id="read-time">0 min de lectura</span>
  </div>
</div>

<script>
  import { saveDiaryEntry } from "../lib/api";
  const textarea = document.getElementById(
    "diary-content",
  ) as HTMLTextAreaElement;
  const dateInput = document.getElementById("diary-date") as HTMLInputElement;
  const charCount = document.getElementById("char-count");
  const readTime = document.getElementById("read-time");
  const saveBtn = document.getElementById("save-btn");

  // Set default date to today
  if (dateInput) {
    const today = new Date().toISOString().split("T")[0];
    dateInput.value = today;
  }

  textarea?.addEventListener("input", () => {
    const content = textarea.value;
    const chars = content.length;
    const words = content.split(" ").filter(Boolean).length;
    const minutes = Math.ceil(words / 200);

    if (charCount) charCount.textContent = `${chars} caracteres`;
    if (readTime) readTime.textContent = `${minutes} min de lectura`;
  });

  saveBtn?.addEventListener("click", async () => {
    const content = textarea?.value;
    const selectedDate = dateInput?.value;
    if (!content) return;

    // Change button state to loading
    const originalText = saveBtn.innerHTML;
    saveBtn.textContent = "Guardando...";
    saveBtn.setAttribute("disabled", "true");

    try {
      await saveDiaryEntry(content, selectedDate);
      alert("¡Entrada guardada exitosamente!");
      textarea.value = ""; // Clear textarea if desired, or keep it
      // Reset counters
      if (charCount) charCount.textContent = `0 caracteres`;
      if (readTime) readTime.textContent = `0 min de lectura`;
    } catch (error) {
      console.error("Error saving entry:", error);
      alert(
        "Error al guardar: " +
          (error instanceof Error ? error.message : "Error desconocido"),
      );
    } finally {
      // Restore button state
      saveBtn.innerHTML = originalText;
      saveBtn.removeAttribute("disabled");
    }
  });
</script>

<style>
  button {
    cursor: pointer;
    border: none;
  }
</style>
